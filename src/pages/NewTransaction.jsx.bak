import { useState, useEffect } from "react";
import { useNavigate } from "react-router-dom";
import axios from "../utils/axios";

const NewTransaction = () => {
  const navigate = useNavigate();
  const [categories, setCategories] = useState([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState("");
  const [success, setSuccess] = useState("");

  const [formData, setFormData] = useState({
    category: "",
    hasGSTInvoice: false,
    invoiceDate: new Date().toISOString().split("T")[0],
    payeeClientName: "",
    purpose: "",
    preTaxAmount: "",
    taxAmount: "",
    postTaxAmount: "",
    paymentDate: new Date().toISOString().split("T")[0],
    paymentMode: "Cash",
  });

  const [invoiceFile, setInvoiceFile] = useState(null);
  const [paymentProofFile, setPaymentProofFile] = useState(null);

  useEffect(() => {
    fetchCategories();
  }, []);

  const fetchCategories = async () => {
    try {
      const response = await axios.get("/categories");
      setCategories(response.data.data);
    } catch (err) {
      console.error("Error fetching categories:", err);
    }
  };

  const handleInputChange = (e) => {
    const { name, value, type, checked } = e.target;
    setFormData((prev) => ({
      ...prev,
      [name]: type === "checkbox" ? checked : value,
    }));
  };

  const handleAmountChange = (field, value) => {
    const numValue = parseFloat(value) || 0;
    const updatedData = { ...formData, [field]: value };

    // Auto-calculate postTaxAmount if preTax and tax are available
    if (field === "preTaxAmount" || field === "taxAmount") {
      const preTax =
        field === "preTaxAmount"
          ? numValue
          : parseFloat(formData.preTaxAmount) || 0;
      const tax =
        field === "taxAmount" ? numValue : parseFloat(formData.taxAmount) || 0;
      updatedData.postTaxAmount = (preTax + tax).toFixed(2);
    }

    setFormData(updatedData);
  };

  const handleFileChange = (e, type) => {
    const file = e.target.files[0];
    if (type === "invoice") {
      setInvoiceFile(file);
    } else {
      setPaymentProofFile(file);
    }
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    setLoading(true);
    setError("");
    setSuccess("");

    try {
      const formDataToSend = new FormData();

      // Append all text fields
      Object.keys(formData).forEach((key) => {
        formDataToSend.append(key, formData[key]);
      });

      // Append files
      if (invoiceFile) {
        formDataToSend.append("invoiceImage", invoiceFile);
      }
      if (paymentProofFile) {
        formDataToSend.append("paymentProofImage", paymentProofFile);
      }

      const response = await axios.post("/transactions", formDataToSend, {
        headers: {
          "Content-Type": "multipart/form-data",
        },
      });

      setSuccess(
        "Transaction submitted successfully! Waiting for admin approval.",
      );

      // Reset form after 2 seconds
      setTimeout(() => {
        navigate("/transactions");
      }, 2000);
    } catch (err) {
      setError(err.response?.data?.message || "Failed to submit transaction");
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="min-h-screen bg-[#F6F6F6]">
      {/* Header */}
      <div className="bg-[#163172] text-white py-6 px-4 shadow-lg">
        <div className="max-w-4xl mx-auto flex items-center justify-between">
          <div>
            <h1 className="text-3xl font-bold">Submit New Expense</h1>
            <p className="text-[#D6E4F0] mt-2">
              Fill in the expense details below
            </p>
          </div>
          <button
            onClick={() => navigate("/dashboard")}
            className="px-4 py-2 bg-white/20 hover:bg-white/30 rounded-lg transition"
          >
            ← Back
          </button>
        </div>
      </div>

      <div className="max-w-4xl mx-auto px-4 py-8">
        {error && (
          <div className="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg mb-6">
            {error}
          </div>
        )}

        {success && (
          <div className="bg-green-50 border border-green-200 text-green-700 px-4 py-3 rounded-lg mb-6">
            {success}
          </div>
        )}

        <form
          onSubmit={handleSubmit}
          className="bg-white rounded-xl shadow-lg p-8"
        >
          {/* Category */}
          <div className="mb-6">
            <label className="block text-sm font-semibold text-gray-700 mb-2">
              Expense Category *
            </label>
            <select
              name="category"
              value={formData.category}
              onChange={handleInputChange}
              className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#1E56A0] focus:border-[#1E56A0]"
              required
            >
              <option value="">Select Category</option>
              {categories.map((cat) => (
                <option key={cat._id} value={cat._id}>
                  {cat.name} ({cat.code})
                </option>
              ))}
            </select>
          </div>

          {/* GST Invoice Toggle */}
          <div className="mb-6">
            <label className="flex items-center space-x-3 cursor-pointer">
              <input
                type="checkbox"
                name="hasGSTInvoice"
                checked={formData.hasGSTInvoice}
                onChange={handleInputChange}
                className="w-5 h-5 text-[#1E56A0] border-gray-300 rounded focus:ring-[#1E56A0]"
              />
              <span className="text-sm font-semibold text-gray-700">
                This expense has a GST Invoice
              </span>
            </label>
          </div>

          <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            {/* Invoice Date */}
            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-2">
                Invoice Date *
              </label>
              <input
                type="date"
                name="invoiceDate"
                value={formData.invoiceDate}
                onChange={handleInputChange}
                className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#1E56A0] focus:border-[#1E56A0]"
                required
              />
            </div>

            {/* Payee/Client Name */}
            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-2">
                Payee/Client Name *
              </label>
              <input
                type="text"
                name="payeeClientName"
                value={formData.payeeClientName}
                onChange={handleInputChange}
                className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#1E56A0] focus:border-[#1E56A0]"
                placeholder="e.g., ABC Suppliers"
                required
              />
            </div>
          </div>

          {/* Purpose */}
          <div className="mb-6">
            <label className="block text-sm font-semibold text-gray-700 mb-2">
              Purpose/Description *
            </label>
            <textarea
              name="purpose"
              value={formData.purpose}
              onChange={handleInputChange}
              className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#1E56A0] focus:border-[#1E56A0]"
              placeholder="Describe the expense purpose..."
              rows="3"
              required
            />
          </div>

          {/* Amount Fields */}
          <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-2">
                Pre-Tax Amount (₹) *
              </label>
              <input
                type="number"
                name="preTaxAmount"
                value={formData.preTaxAmount}
                onChange={(e) =>
                  handleAmountChange("preTaxAmount", e.target.value)
                }
                className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#1E56A0] focus:border-[#1E56A0]"
                placeholder="0.00"
                step="0.01"
                min="0"
                required
              />
            </div>

            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-2">
                Tax Amount (₹)
              </label>
              <input
                type="number"
                name="taxAmount"
                value={formData.taxAmount}
                onChange={(e) =>
                  handleAmountChange("taxAmount", e.target.value)
                }
                className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#1E56A0] focus:border-[#1E56A0]"
                placeholder="0.00"
                step="0.01"
                min="0"
              />
            </div>

            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-2">
                Post-Tax Amount (₹) *
              </label>
              <input
                type="number"
                name="postTaxAmount"
                value={formData.postTaxAmount}
                onChange={handleInputChange}
                className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#1E56A0] focus:border-[#1E56A0] bg-gray-50"
                placeholder="0.00"
                step="0.01"
                min="0"
                required
                readOnly
              />
            </div>
          </div>

          <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            {/* Payment Date */}
            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-2">
                Payment Date *
              </label>
              <input
                type="date"
                name="paymentDate"
                value={formData.paymentDate}
                onChange={handleInputChange}
                className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#1E56A0] focus:border-[#1E56A0]"
                required
              />
            </div>

            {/* Payment Mode */}
            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-2">
                Payment Mode *
              </label>
              <select
                name="paymentMode"
                value={formData.paymentMode}
                onChange={handleInputChange}
                className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#1E56A0] focus:border-[#1E56A0]"
                required
              >
                <option value="Cash">Cash</option>
                <option value="UPI">UPI</option>
                <option value="Card">Card</option>
                <option value="Bank Transfer">Bank Transfer</option>
              </select>
            </div>
          </div>

          {/* File Uploads */}
          <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            {/* Invoice Image */}
            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-2">
                Invoice/Bill Image {formData.hasGSTInvoice && "*"}
              </label>
              <input
                type="file"
                onChange={(e) => handleFileChange(e, "invoice")}
                className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#1E56A0] focus:border-[#1E56A0]"
                accept="image/*"
                required={formData.hasGSTInvoice}
              />
              {invoiceFile && (
                <p className="text-sm text-gray-600 mt-2">
                  Selected: {invoiceFile.name}
                </p>
              )}
            </div>

            {/* Payment Proof */}
            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-2">
                Payment Proof (GPay/UPI Screenshot) *
              </label>
              <input
                type="file"
                onChange={(e) => handleFileChange(e, "payment")}
                className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#1E56A0] focus:border-[#1E56A0]"
                accept="image/*"
                required
              />
              {paymentProofFile && (
                <p className="text-sm text-gray-600 mt-2">
                  Selected: {paymentProofFile.name}
                </p>
              )}
            </div>
          </div>

          {/* Submit Button */}
          <div className="flex items-center justify-end space-x-4 pt-6 border-t border-gray-200">
            <button
              type="button"
              onClick={() => navigate("/dashboard")}
              className="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition"
            >
              Cancel
            </button>
            <button
              type="submit"
              disabled={loading}
              className="px-6 py-3 bg-[#1E56A0] hover:bg-[#163172] text-white font-semibold rounded-lg transition disabled:opacity-50 disabled:cursor-not-allowed"
            >
              {loading ? "Submitting..." : "Submit Expense"}
            </button>
          </div>
        </form>
      </div>
    </div>
  );
};

export default NewTransaction;
